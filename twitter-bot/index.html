<!DOCTYPE html>
<html lang="it">

<head>
    <title>Gabelluardo</title>
    
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#1F222A">

<link rel="stylesheet" href="https://gabelluardo.github.io/style.css">


<link rel="stylesheet"
  href="https://gabelluardo.github.io/color/green.css">




<link rel="stylesheet"
  href="https://gabelluardo.github.io/color/background_blue.css">



<!-- Fira font support -->
<link rel="stylesheet" href="https://gabelluardo.github.io/font-fira.css">

<!-- Analytics and trakers -->





<!-- Goatcounter -->
<script data-goatcounter="https://gabelluardo.goatcounter.com/count" async
  src="//gc.zgo.at/count.js"></script>
<!-- End Goatcounter Code -->




    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://gabelluardo.github.io/rss.xml">
    

    
        <link rel="apple-touch-icon" sizes="180x180" href="https:&#x2F;&#x2F;gabelluardo.github.io&#x2F;apple-touch-icon.png" />
        <link rel="shortcut icon" type="image&#x2F;png" href="/favicon-32x32.png">
    

    
    
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                
                    
                
                <a href="https://gabelluardo.github.io" style="text-decoration: none;">
                    <div class="logo">
                        
                            Gabelluardo
                        
                    </div>
                </a>
            </div>
        </div>

        
          
    
        

        <nav class="menu">
            <ul class="menu__inner">
            
                
                
                

                
                    
                

                
            
                
                
                

                

                
            
                
                
                

                

                
            
                
                
                

                

                
            
                
                
                

                

                
            
                
                
                

                

                
            

            
                
                
            

            
                <li  class="active" >
                    
                        <a href="https://gabelluardo.github.io">blog</a>
                    
                </li>
            
                <li >
                    
                        <a href="https://gabelluardo.github.io/tags">tags</a>
                    
                </li>
            
                <li >
                    
                        <a href="https://gabelluardo.github.io/archive">archive</a>
                    
                </li>
            
                <li >
                    
                        <a href="https://gabelluardo.github.io/about">about</a>
                    
                </li>
            
                <li >
                    
                        <a href="https://github.com/gabelluardo" target="_blank" rel="noopener noreferrer">github</a>
                    
                </li>
            
                <li >
                    
                        <a href="https://twitter.com/ugabbel" target="_blank" rel="noopener noreferrer">twitter</a>
                    
                </li>
            
            </ul>
        </nav>
    

        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://gabelluardo.github.io/twitter-bot/">Bot twitter in Rust</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
        
            2020-08-06
        
    </span>

    </div>

    
    
        <span class="post-tags-inline">
            
                :: tags:&nbsp;
                
            
            
                <a class="post-tag" href="https://gabelluardo.github.io/tags/twitter/">#twitter</a>
                &nbsp;
            
                <a class="post-tag" href="https://gabelluardo.github.io/tags/bot/">#bot</a>
                &nbsp;
            
                <a class="post-tag" href="https://gabelluardo.github.io/tags/rust/">#rust</a>
                &nbsp;
            
                <a class="post-tag" href="https://gabelluardo.github.io/tags/async/">#async</a>
                &nbsp;
            
                <a class="post-tag" href="https://gabelluardo.github.io/tags/tokio/">#tokio</a>
                
            
        </span>
    


        
    
        <div class="post-content">
            <p>Ho iniziato a studiare <a href="https://www.rust-lang.org/it">Rust</a> a tempo perso qualche mese fa, tra un esame e l'altro.
È oggettivamente un linguaggio difficile da usare e senza un IDE o dei plug-in 
per l'editor può diventare un incubo anche scrivere programmi basilari.</p>
<span id="continue-reading"></span>
<p>Piuttosto che Rust avrebbero dovuto chiamarlo Doom...</p>
<img class="media" src="https://media.giphy.com/media/1xNApQKoX1uW2vhVE9/giphy.gif">
<p>Squallore a parte, dopo aver letto molteplici libri e guide e dopo essere stato seviziato dal compilatore innumerevoli volte, ho deciso di sperimentare un po' con un'applicazione di reale utilità: mi serviva un bot che twittasse in automatico ogni volta che veniva pubblicato un nuovo blog post.</p>
<p>Niente di troppo difficile: esiste già un ottimo <a href="https://github.com/egg-mode-rs/egg-mode">crate</a> per le api di twitter e un altro per il parsing del <a href="https://github.com/rust-syndication/rss">feed rss</a>.<br />
Il grosso del lavoro è quindi procurarsi le credenziali da sviluppatore di <a href="https://developer.twitter.com">twitter</a> e salvarle come variabili d'ambiente in un file <code>.env</code> , che ci serviranno per generare il token per accedere alle api di twitter.</p>
<p>Dato che con Rust ci viene fornito anche il comodissimo <a href="https://github.com/rust-lang/cargo">cargo</a> che si occupa della struttura, della compilazione e della pubblicazione su <a href="https://crates.io">crate.io</a> del progetto, quello che otteniamo lanciando <code>cargo new twitter-bot</code> è questo:</p>
<pre style="background-color:#282c34;">
<code><span style="color:#e06c75;">twitter-bot
  ├──</span><span style="color:#abb2bf;"> Cargo.lock
  </span><span style="color:#e06c75;">├──</span><span style="color:#abb2bf;"> Cargo.toml
  </span><span style="color:#e06c75;">├──</span><span style="color:#abb2bf;"> LICENSE
  </span><span style="color:#e06c75;">├──</span><span style="color:#abb2bf;"> README.md
  </span><span style="color:#e06c75;">└──</span><span style="color:#abb2bf;"> src
      </span><span style="color:#e06c75;">└──</span><span style="color:#abb2bf;"> main.rs
</span></code></pre>
<p>Sempre con spirito di intraprendenza, ho voluto sperimentare anche <a href="https://tokio.rs">tokio</a>: un runtime per programmazione asincrona, praticamente lo standard de facto in Rust dall'introduzione dell'async/await di qualche anno fa. Per impostarlo basta aggiungerlo come dipendenza in <code>Cargo.toml</code> e usare le macro a disposizione:</p>
<pre style="background-color:#282c34;">
<code><span style="color:#abb2bf;">[dependencies.tokio]
 </span><span style="color:#e06c75;">version </span><span style="color:#abb2bf;">= </span><span style="color:#98c379;">&quot;0.2&quot;
 </span><span style="color:#e06c75;">features </span><span style="color:#abb2bf;">= [</span><span style="color:#98c379;">&quot;macros&quot;</span><span style="color:#abb2bf;">]
</span></code></pre>
<p>oppure</p>
<pre style="background-color:#282c34;">
<code><span style="color:#e06c75;">tokio </span><span style="color:#abb2bf;">= {</span><span style="color:#e06c75;">version </span><span style="color:#abb2bf;">= </span><span style="color:#98c379;">&quot;0.2&quot;</span><span style="color:#abb2bf;">, </span><span style="color:#e06c75;">features </span><span style="color:#abb2bf;">= [</span><span style="color:#98c379;">&quot;macros&quot;</span><span style="color:#abb2bf;">]}
</span></code></pre>
<p>Nel main in <code>main.rs</code> , che useremo come entry point:</p>
<pre style="background-color:#282c34;">
<code><span style="color:#abb2bf;">#[</span><span style="color:#e06c75;">tokio</span><span style="color:#abb2bf;">::</span><span style="color:#e06c75;">main</span><span style="color:#abb2bf;">]
 async </span><span style="color:#c678dd;">fn </span><span style="color:#61afef;">main</span><span style="color:#abb2bf;">() {}
</span></code></pre>
<p>Il runtime async ci servirà soprattuto per le richieste http non bloccanti che fanno risparmiare risorse di sistema. In particolare, usando <a href="https://github.com/seanmonstar/reqwest">reqwest</a>, che supporta tokio, possiamo scrivere:</p>
<pre style="background-color:#282c34;">
<code><span style="color:#abb2bf;">reqwest::get(url).await</span><span style="color:#56b6c2;">?</span><span style="color:#abb2bf;">.</span><span style="color:#56b6c2;">bytes</span><span style="color:#abb2bf;">().await</span><span style="color:#56b6c2;">?
</span></code></pre>
<p>Il <code>?</code> è zucchero sintattico per il try-catch di Rust che propaga l'errore, una scrittura equivalente sarebbe:</p>
<pre style="background-color:#282c34;">
<code><span style="color:#c678dd;">match </span><span style="color:#abb2bf;">request::get(url).await {
  Ok(response) </span><span style="color:#56b6c2;">=&gt; </span><span style="color:#c678dd;">match</span><span style="color:#abb2bf;"> response.</span><span style="color:#56b6c2;">byte</span><span style="color:#abb2bf;">().await {
    Ok(response) </span><span style="color:#56b6c2;">=&gt;</span><span style="color:#abb2bf;"> response,
    Err(e) </span><span style="color:#56b6c2;">=&gt; </span><span style="color:#c678dd;">return </span><span style="color:#abb2bf;">Err(e),
  },
  Err(e) </span><span style="color:#56b6c2;">=&gt; </span><span style="color:#c678dd;">return </span><span style="color:#abb2bf;">Err(e),
}
</span></code></pre>
<p>Non c'è nemmeno bisogno di dire quale sia la più leggibile, però bisogna ricordarsi che per propagare gli errori si deve usare l'enum generico <code>Result&lt;T, E&gt;</code> , quindi il main deve essere leggermente modificato: </p>
<pre style="background-color:#282c34;">
<code><span style="color:#c678dd;">use </span><span style="color:#abb2bf;">std::error:: Error; 
</span><span style="color:#c678dd;">use </span><span style="color:#abb2bf;">std::result:: Result; 

#[</span><span style="color:#e06c75;">tokio</span><span style="color:#abb2bf;">::</span><span style="color:#e06c75;">main</span><span style="color:#abb2bf;">]
async </span><span style="color:#c678dd;">fn </span><span style="color:#61afef;">main</span><span style="color:#abb2bf;">() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {}

</span></code></pre>
<p>Un'altra funzione comoda di Rust è <code>loop</code> , che fornisce di defalut un ciclo infinito in cui possiamo:</p>
<ol>
<li>ricavare le informazioni dell'ultimo post del blog</li>
<li>ricavare la data dell'ultimo tweet del nostro account</li>
<li>controllare che il post sia più recente dell'ultimo tweet, quindi pubblicarlo</li>
<li>sleep per x secondi prima di ripetere il ciclo</li>
</ol>
<pre style="background-color:#282c34;">
<code><span style="color:#c678dd;">loop </span><span style="color:#abb2bf;">{  
    </span><span style="color:#c678dd;">let</span><span style="color:#abb2bf;"> post </span><span style="color:#56b6c2;">= last_post</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">...</span><span style="color:#abb2bf;">).await</span><span style="color:#56b6c2;">?</span><span style="color:#abb2bf;">;
    </span><span style="color:#c678dd;">let</span><span style="color:#abb2bf;"> last_tweet_date </span><span style="color:#56b6c2;">= last_tweet</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">...</span><span style="color:#abb2bf;">).await</span><span style="color:#56b6c2;">?</span><span style="color:#abb2bf;">;

    </span><span style="color:#c678dd;">if</span><span style="color:#abb2bf;"> post.date </span><span style="color:#56b6c2;">&gt;</span><span style="color:#abb2bf;"> last_tweet_date {
        </span><span style="color:#56b6c2;">publish</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">...</span><span style="color:#abb2bf;">).await</span><span style="color:#56b6c2;">?</span><span style="color:#abb2bf;">;
    }

    tokio::time::delay_for(Duration::from_secs(</span><span style="color:#56b6c2;">...</span><span style="color:#abb2bf;">)).await
  }
</span></code></pre>
<p>Penso che le parti interessanti siano su per giù queste, il repository completo è comunque su <a href="https://github.com/gabelluardo/twitter-bot">github</a></p>
<img class="media" src="/assets/ferris.gif">

        </div>
    

        
    

    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
            
                <div class="copyright">
                    
                        <span>© 
    2020
 Gabriele Belluardo</span>
                    
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a>
                        
  
    <span class="copyright-theme-sep">:: </span>
    <a href="https://gabelluardo.github.io/rss.xml" target="_blank" title="rss" download>
    <svg
      xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-rss">
      <path d="M4 11a9 9 0 0 1 9 9"></path>
      <path d="M4 4a16 16 0 0 1 16 16"></path>
      <circle cx="5" cy="19" r="1"></circle>
    </svg>
    </a>
  

                    </span>
                </div>
            
        </div>
    </footer>
    

</div>
</body>

</html>
